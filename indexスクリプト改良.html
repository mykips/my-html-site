<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <!-- HTTPSÁí∞Â¢É„Åã localhost „ÅßÂãï‰Ωú„Åï„Åõ„Çã„Åü„ÇÅ„ÅÆ viewport Ë®≠ÂÆö -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Guchapy Recording</title>
  <style>
    /* ÂÖ®‰Ωì„É™„Çª„ÉÉ„Éà */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      box-sizing: border-box;
      overflow-x: hidden;
      font-family: sans-serif;
    }
    /* „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„ÅÆÂÖ±ÈÄö„Çπ„Çø„Ç§„É´ */
    .progressContainer {
      width: 100%;
      height: 10px;
      background: #ddd;
      position: relative;
      margin-top: 5px;
      border-radius: 5px;
    }
    #recordProgressBar,
    #progressBar {
      width: 0%;
      height: 100%;
      border-radius: 5px;
      transition: width 0.1s linear;
    }
    #recordProgressBar { background: red; }
    #progressBar { background: blue; touch-action: none; }
    #waveform {
      width: 100%;
      height: 128px;
      border: 1px solid #ccc;
      margin-top: 20px;
    }
    p { margin: 5px 0; }
    .recordingArea { margin-bottom: 50px; }
    .playbackArea { margin-top: 50px; }
    /* Post„Éú„Çø„É≥Áî® */
    #postBtn {
      display: inline-block;
      margin: 20px auto;
      padding: 10px 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="recordingArea">
    <!-- Èå≤Èü≥Èñ¢ÈÄ£ -->
    <button id="startRecord">üé§ Start Recording</button>
    <button id="pauseRecord" disabled>‚è∏ Pause</button>
    <button id="stopRecord" disabled>‚èπ Stop</button>
    <p>Recording Time: <span id="recordTime">00:00</span></p>
    <div class="progressContainer">
      <div id="recordProgressBar"></div>
    </div>
  </div>

  <div class="playbackArea">
    <!-- ÂÜçÁîüÈñ¢ÈÄ£ -->
    <button id="playBtn" disabled>‚ñ∂ Play</button>
    <button id="pauseBtn" disabled>‚è∏ Pause</button>
    <button id="stopBtn" disabled>‚èπ Stop</button>
    <div style="margin-top: 5px; margin-bottom: 0;">
      <label for="speedControl">Speed (Playback Only):</label>
      <select id="speedControl" disabled>
        <option value="0.5">0.5x</option>
        <option value="1.0" selected>1.0x</option>
        <option value="1.5">1.5x</option>
        <option value="2.0">2.0x</option>
      </select>
    </div>
    <p style="margin-top: 5px;">Playback Time: <span id="playbackTime">00:00</span></p>
    <div class="progressContainer">
      <div id="progressBar"></div>
    </div>
  </div>

  <div style="text-align: center;">
    <button id="postBtn" disabled>Post</button>
  </div>
  
  <div id="waveform"></div>

  <!-- WaveSurfer.js CDN -->
  <script src="https://unpkg.com/wavesurfer.js"></script>
  
  <!-- „É°„Ç§„É≥„Çπ„ÇØ„É™„Éó„ÉàÔºöES„É¢„Ç∏„É•„Éº„É´ÊñπÂºè -->
  <script type="module">
    // Firebase SDK „ÅÆ„Ç§„É≥„Éù„Éº„Éà
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";
    
    // Firebase „Ç≥„É≥„ÇΩ„Éº„É´„Åã„ÇâÂèñÂæó„Åó„ÅüË®≠ÂÆöÊÉÖÂ†±
    const firebaseConfig = {
      apiKey: "AIzaSyBTMdM4qaqQUJ7L0V3y8MIXMALJuanycMo",
      authDomain: "guchapy-72mce7.firebaseapp.com",
      projectId: "guchapy-72mce7",
      storageBucket: "guchapy-72mce7.firebasestorage.app",
      messagingSenderId: "260711246639",
      appId: "1:260711246639:web:a42eb11b20fb8fc4aecfda"
    };
    
    // Firebase ÂàùÊúüÂåñ„Å® Storage ÂèÇÁÖß„ÅÆÂèñÂæó
    const appFirebase = initializeApp(firebaseConfig);
    const storage = getStorage(appFirebase);
    
    // Èå≤Èü≥„ÉªÂÜçÁîüÈñ¢ÈÄ£„ÅÆ„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
    let mediaRecorder = null;
    let audioChunks = [];
    let recordTime = 0;          // Èå≤Èü≥ÁµåÈÅéÊôÇÈñìÔºàÁßíÔºâ
    let recordTimer = null;
    const MAX_RECORD_TIME = 60;  // ÊúÄÂ§ßÈå≤Èü≥ÁßíÊï∞
    let waveSurfer = null;
    let isScrubbing = false;
    let wasPlayingBeforeScrub = false;
    let recordedBlob = null;     // Èå≤Èü≥„Éá„Éº„Çø„ÅÆ Blob
    
    // UI Ë¶ÅÁ¥†„ÅÆÂèñÂæó
    const startRecBtn = document.getElementById("startRecord");
    const pauseRecBtn = document.getElementById("pauseRecord");
    const stopRecBtn  = document.getElementById("stopRecord");
    const recordTimeLabel = document.getElementById("recordTime");
    const recordProgressBar = document.getElementById("recordProgressBar");
    
    const playBtn = document.getElementById("playBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const stopBtn = document.getElementById("stopBtn");
    const playbackTimeLabel = document.getElementById("playbackTime");
    const playbackProgressBar = document.getElementById("progressBar");
    const speedSelect = document.getElementById("speedControl");
    const postBtn = document.getElementById("postBtn");
    
    // „Éá„Éê„ÉÉ„Ç∞Áî®: „Éû„Ç§„ÇØÊ®©Èôê„ÅÆÁä∂ÊÖã„Çí„É≠„Ç∞Âá∫ÂäõÔºàPermissions API „ÅåÂà©Áî®„Åß„Åç„ÇãÂ†¥ÂêàÔºâ
    if (navigator.permissions) {
      navigator.permissions.query({ name: "microphone" })
        .then(permissionStatus => {
          console.log("Microphone permission state:", permissionStatus.state);
          permissionStatus.onchange = () => {
            console.log("Microphone permission state changed to:", permissionStatus.state);
          };
        })
        .catch(err => {
          console.error("Permissions API „Ç®„É©„Éº:", err);
        });
    } else {
      console.log("Permissions API „ÅØ„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ");
    }
    
    // Èå≤Èü≥ÈñãÂßã„Éú„Çø„É≥„ÅÆÂá¶ÁêÜ
    startRecBtn.addEventListener("click", async () => {
      console.log("Start Recording „Éú„Çø„É≥„ÅåÊäº„Åï„Çå„Åæ„Åó„Åü");
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ getUserMedia „Çí„Çµ„Éù„Éº„Éà„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ");
        return;
      }
      
      if (!mediaRecorder || mediaRecorder.state === "inactive") {
        try {
          console.log("getUserMedia „ÇíÂëº„Å≥Âá∫„Åó„Åæ„Åô");
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          console.log("„Çπ„Éà„É™„Éº„É†ÂèñÂæóÊàêÂäü", stream);
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.start();
          console.log("Èå≤Èü≥ÈñãÂßã");
          audioChunks = [];
          mediaRecorder.ondataavailable = e => {
            console.log("„Éá„Éº„ÇøÂèó‰ø°:", e.data);
            audioChunks.push(e.data);
          };
          recordTime = 0;
          updateRecordTime();
          updateRecordProgress(0);
          recordTimer = setInterval(() => {
            recordTime += 0.1;
            updateRecordTime();
            updateRecordProgress((recordTime / MAX_RECORD_TIME) * 100);
            if (recordTime >= MAX_RECORD_TIME) stopRecording();
          }, 100);
          startRecBtn.disabled = true;
          pauseRecBtn.disabled = false;
          stopRecBtn.disabled = false;
        } catch (err) {
          console.error("getUserMedia „Ç®„É©„Éº:", err);
          alert("„Éû„Ç§„ÇØ„ÅÆ„Ç¢„ÇØ„Çª„Çπ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Ç®„É©„Éº: " + err.name + " - " + err.message);
        }
      } else if (mediaRecorder.state === "paused") {
        mediaRecorder.resume();
        recordTimer = setInterval(() => {
          recordTime += 0.1;
          updateRecordTime();
          updateRecordProgress((recordTime / MAX_RECORD_TIME) * 100);
          if (recordTime >= MAX_RECORD_TIME) stopRecording();
        }, 100);
        startRecBtn.disabled = true;
        pauseRecBtn.disabled = false;
      }
    });
    
    // Èå≤Èü≥‰∏ÄÊôÇÂÅúÊ≠¢„Éú„Çø„É≥„ÅÆÂá¶ÁêÜ
    pauseRecBtn.addEventListener("click", () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.pause();
        clearInterval(recordTimer);
        startRecBtn.disabled = false;
        pauseRecBtn.disabled = true;
        console.log("Èå≤Èü≥‰∏ÄÊôÇÂÅúÊ≠¢");
      }
    });
    
    // Èå≤Èü≥ÂÅúÊ≠¢„Éú„Çø„É≥„ÅÆÂá¶ÁêÜ
    stopRecBtn.addEventListener("click", stopRecording);
    
    function stopRecording() {
      if (!mediaRecorder) return;
      if (mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
        console.log("Èå≤Èü≥ÂÅúÊ≠¢");
      }
      clearInterval(recordTimer);
      updateRecordTime(true);
      stopRecBtn.disabled = true;
      startRecBtn.disabled = false;
      pauseRecBtn.disabled = true;
      mediaRecorder.onstop = () => {
        recordedBlob = new Blob(audioChunks, { type: "audio/webm" });
        console.log("Èå≤Èü≥ÂÆå‰∫Ü„ÄÅBlob „Çµ„Ç§„Ç∫:", recordedBlob.size);
        initWaveSurfer(recordedBlob);
        // Èå≤Èü≥ÂÆå‰∫ÜÂæå„ÄÅPost„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
        postBtn.disabled = false;
      };
    }
    
    function updateRecordTime(stopped = false) {
      const ds = Math.floor(recordTime);
      const m = Math.floor(ds / 60);
      const s = ds % 60;
      recordTimeLabel.textContent = `${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
      if (stopped) recordTimeLabel.textContent += " ‚úÖ";
    }
    
    function updateRecordProgress(perc) {
      recordProgressBar.style.width = perc + "%";
    }
    
    // WaveSurfer „ÅÆÂàùÊúüÂåñ„Å®ÂÜçÁîüÂà∂Âæ°
    function initWaveSurfer(blob) {
      if (waveSurfer) waveSurfer.destroy();
      waveSurfer = WaveSurfer.create({
        container: "#waveform",
        waveColor: "violet",
        progressColor: "purple",
        cursorColor: "navy",
        height: 128,
        responsive: true
      });
      waveSurfer.load(URL.createObjectURL(blob));
      waveSurfer.on("ready", () => {
        playBtn.disabled = false;
        pauseBtn.disabled = true;
        stopBtn.disabled = true;
        speedSelect.disabled = false;
        playbackTimeLabel.textContent = "00:00";
        playbackProgressBar.style.width = "0%";
        console.log("WaveSurfer „ÅÆÊ∫ñÂÇôÂÆå‰∫Ü");
      });
      waveSurfer.on("audioprocess", () => { if (!isScrubbing) updatePlaybackUI(); });
      waveSurfer.on("seek", updatePlaybackUI);
      waveSurfer.on("interaction", updatePlaybackUI);
      waveSurfer.on("finish", () => {
        playBtn.disabled = false;
        pauseBtn.disabled = true;
        stopBtn.disabled = true;
        playbackTimeLabel.textContent += " ‚úÖ";
        playbackProgressBar.style.width = "0%";
      });
    }
    
    playBtn.addEventListener("click", () => {
      if (!waveSurfer) return;
      waveSurfer.play();
      playBtn.disabled = true;
      pauseBtn.disabled = false;
      stopBtn.disabled = false;
      console.log("ÂÜçÁîüÈñãÂßã");
    });
    
    pauseBtn.addEventListener("click", () => {
      if (!waveSurfer) return;
      waveSurfer.pause();
      playBtn.disabled = false;
      pauseBtn.disabled = true;
      console.log("ÂÜçÁîü‰∏ÄÊôÇÂÅúÊ≠¢");
    });
    
    stopBtn.addEventListener("click", () => {
      if (!waveSurfer) return;
      waveSurfer.stop();
      playBtn.disabled = false;
      pauseBtn.disabled = true;
      stopBtn.disabled = true;
      updatePlaybackUI();
      console.log("ÂÜçÁîüÂÅúÊ≠¢");
    });
    
    speedSelect.addEventListener("change", (e) => {
      if (!waveSurfer) return;
      const rate = parseFloat(e.target.value);
      waveSurfer.setPlaybackRate(rate);
      console.log("ÂÜçÁîüÈÄüÂ∫¶Â§âÊõ¥:", rate);
    });
    
    function updatePlaybackUI() {
      const cur = waveSurfer.getCurrentTime();
      const dur = waveSurfer.getDuration();
      playbackTimeLabel.textContent = formatTime(cur);
      playbackProgressBar.style.width = dur > 0 ? (cur / dur) * 100 + "%" : "0%";
    }
    
    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
    }
    
    const playbackContainer = document.querySelectorAll(".progressContainer")[1];
    playbackContainer.addEventListener("pointerdown", onPointerDown);
    playbackContainer.addEventListener("pointermove", onPointerMove);
    playbackContainer.addEventListener("pointerup", onPointerUp);
    playbackContainer.addEventListener("pointercancel", onPointerUp);
    playbackContainer.addEventListener("pointerleave", onPointerUp);
    
    function onPointerDown(e) {
      if (!waveSurfer) return;
      isScrubbing = true;
      wasPlayingBeforeScrub = !waveSurfer.isPaused();
      waveSurfer.pause();
      seekByPointer(e);
    }
    
    function onPointerMove(e) {
      if (!isScrubbing) return;
      seekByPointer(e);
    }
    
    function onPointerUp(e) {
      if (!isScrubbing) return;
      seekByPointer(e);
      isScrubbing = false;
      if (wasPlayingBeforeScrub) {
        waveSurfer.play();
        playBtn.disabled = true;
        pauseBtn.disabled = false;
        stopBtn.disabled = false;
      }
    }
    
    function seekByPointer(e) {
      const rect = playbackContainer.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const fraction = Math.max(0, Math.min(x / rect.width, 1));
      waveSurfer.seekTo(fraction);
      updatePlaybackUI();
    }
    
    // Firebase Storage „Å∏„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÈñ¢Êï∞
    async function uploadRecordedAudio(blob) {
      try {
        const fileName = `recordings/${Date.now()}.webm`;
        const storageRef = ref(storage, fileName);
        const snapshot = await uploadBytes(storageRef, blob);
        const downloadURL = await getDownloadURL(snapshot.ref);
        console.log("Uploaded successfully! URL:", downloadURL);
        alert("„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂÆå‰∫ÜÔºÅ\nURL: " + downloadURL);
        return downloadURL;
      } catch (error) {
        console.error("Upload failed:", error);
        alert("„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: " + error.name + " - " + error.message);
        return null;
      }
    }
    
    // Post „Éú„Çø„É≥„ÅÆÂá¶ÁêÜ
    postBtn.addEventListener("click", async () => {
      if (!recordedBlob) {
        alert("Èå≤Èü≥„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ");
        return;
      }
      postBtn.disabled = true;
      const url = await uploadRecordedAudio(recordedBlob);
      if (url) {
        console.log("„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊàêÂäü:", url);
      }
    });
  </script>
</body>
</html>
